!function(){class e{constructor(){this._events={},this.on=this.addEventListener,this.off=this.removeEventListener}emit(e){var t=this._events[e];if(!Array.isArray(t))return!1;t=t.slice();for(var i=Array.prototype.slice.call(arguments,1),s=0;s<t.length;++s)t[s].apply(this,i);return!0}addEventListener(e,t){if("function"!=typeof t)throw new TypeError("listener must be a function");return this._events[e]||(this._events[e]=[]),this._events[e].push(t),this}removeEventListener(e,t){if("function"!=typeof t)throw new TypeError("listener must be a function");var i=this._events[e];if(!Array.isArray(i))return this;for(var s=i.length-1;s>=0;--s)if(i[s]==t||i[s].listener&&i[s].listener==t){i.splice(s,1),i.length||delete this._events[e];break}return this}removeAllListeners(e){return 0===arguments.length?this._events={}:delete this._events[e],this}}var t=["error","open","close","pause","resume","data","message","shakeHandle"];class i{constructor(e,t,i){this.client=e,this.event=t,this.eventId=i,this.reply=this._reply.bind(this)}_uninit(){this.client=void 0,this.reply=void 0}_reply(){if(this.client){var e=void 0,t=Array.prototype.slice.call(arguments),i=t;"message"===this.event&&(1===t.length?i=t[0]:t.length>1&&(e=t[0],i=t[1])),this.client._reply(this.event,this.eventId,e,i),this._uninit()}}}this.MediaClient=class extends e{constructor(e,t,i){if("string"!=typeof e||"function"!=typeof t)throw new TypeError("Argument error.");if(super(),"string"==typeof e){if("function"!=typeof t)throw new TypeError("Argument error.")}else{if("function"!=typeof e)throw new TypeError("Argument error.");i=t,t=e,e=null}i="object"==typeof i?i:{},this.opts=i,this.opts.path=this.opts.path||"/live",this.origin=e,this.log=i.log?i.log:console.log,this.info=i.info?i.info:console.info,this.errInfo=i.error?i.error:console.error,this.timeout=i.timeout?i.timeout:3e4,this.query="",this.updateQuery(),this.id=void 0,this._client=void 0,this._timer=void 0,this._pingState=1,this._pingTimer=void 0,this._opening=!1,this._opened=!1,this._closing=!1,this._closed=!1,this._curEventId=0,this._cbevents={},this.on("shakeHandle",((e,i)=>{var s=0===this.query.length?`?id=${i}`:`${this.query}&&id=${i}`,r=`${this.opts.path}${s}`;t(e,r)}))}updateQuery(){var e=this.opts.token?`?edger-token=${this.opts.token}`:"";this.opts.srand&&(e=0===e.length?`?edger-srand=${this.opts.srand}`:`${e}&&edger-srand=${this.opts.srand}`),this.query=e}destroy(){this._client&&(this._client.close(),this._client=void 0),this._timer&&(clearTimeout(this._timer),this._timer=void 0),this._pingTimer&&(clearInterval(this._pingTimer),this._pingTimer=void 0),this._uninit()}_uninit(){this.log=void 0,this.info=void 0,this.errInfo=void 0,this._reset(),this.removeAllListeners()}_reset(){this._opening=!1,this._opened=!1,this._closing=!1,this._closed=!1,this.id=void 0,this._client=void 0,this._curEventId=0,this._cbevents={},this._pingState=1}_addEvent(e,t){var i=e.toString();return!(i in this._cbevents)&&(this._cbevents[i]=t,!0)}_removeEvent(e){var t=e.toString();t in this._cbevents&&delete this._cbevents[t]}_findEvent(e){var t=e.toString();return t in this._cbevents?this._cbevents[t]:void 0}_genEventId(){return++this._curEventId}open(e){if(!this._opening){if("object"==typeof e){var t=!1;"string"==typeof e.token&&(this.opts.token=e.token,t=!0),"string"==typeof e.srand&&(this.opts.srand=e.srand,t=!0),t&&this.updateQuery()}var i=`${this.origin}${this.opts.path}.media${this.query}`;if(this.info(`data channel url=${i}`),window.WebSocket||(this.log("!window.WebSocket"),window.WebSocket=window.MozWebSocket),window.WebSocket){var s=new WebSocket(i),r=this;s.onopen=function(e){r.info("Data channel connect success.")},s.onmessage=this.onRecv.bind(this),s.onclose=this.onClose.bind(this),this._opening=!0,this._client=s,this._timer=setTimeout((()=>{var e=new Error("Open channel timeout.");e.code="timeout",r.error(e)}),this.timeout)}else this.error(new Error("Not support websocket."))}}close(){this._timer&&(clearTimeout(this._timer),this._timer=void 0),this._pingTimer&&(clearInterval(this._pingTimer),this._pingTimer=void 0),this._closing||(this.info("Close client."),this._closing=!0,this._opened=!1,this._client&&this._client.close(),this.onClose())}error(e){this.emit("error",this,e),this.errInfo(e),this.close()}_send(e,t,i,s,r,n){if(this._opened&&!this._closing&&!this._closed){if("number"!=typeof e||"string"!=typeof t||s&&"Object"!=typeof s)throw new TypeError("Argument error.");if(s=s||{},i="number"==typeof i?i:void 0,n="function"==typeof n?n:void 0,3===e&&!i)throw new TypeError("Argument eventId error.");if(2===e&&!n)throw new TypeError("Argument cb error.");var o={id:this.id,type:e,event:t,opts:s};r&&(o.data=r),2===e?(i=this._genEventId(),o.eventId=i,this._addEvent(i,n)):3===e&&(o.eventId=i),o=JSON.stringify(o),this._client.send(o)}}_reply(e,t,i,s){this._send(3,e,t,i,s)}_recv(e,t,i,s){var r=void 0;"message"===e?r=[e,this,t,i]:i&&Array.isArray(i)?((r=i).unshift(this),r.unshift(e)):r=[e,this],s&&r.push(s),super.emit.apply(this,r)}_startPing(){this._pingTimer||(this._pingTimer=setInterval((()=>{this.emit("ping")}),this.timeout))}send(e,t,i){if(Array.prototype.slice.call(arguments).length<1)throw new TypeError("Argument error.");if(e&&"object"!=typeof e||!t||i&&"function"!=typeof i)throw new TypeError("Argument error.");e=e||void 0;var s=(i=i||void 0)?2:1;this._send(s,"message",void 0,e,t,i)}emit(e){if(~t.indexOf(e))return super.emit.apply(this,arguments),this;if("string"!=typeof e)throw new TypeError("Argument error.");var i=Array.prototype.slice.call(arguments),s=void 0;"function"==typeof i[i.length-1]&&(s=i.pop()),i.shift(),i=i.length>0?i:void 0;var r=s?2:1;return this._send(r,e,void 0,void 0,i,s),this}onRecv(e){var t=e.data;try{var i=JSON.parse(t)}catch(e){this.error(e)}var s=i.id;switch(e=i.event){case"shakeHandle":this.id=s,super.emit.call(this,"shakeHandle",this,s);break;case"open":this.onOpen();break;case"close":this.onClose();break;case"data":super.emit.call(this,"data",this,i.opts,i.data);break;default:return void this.onMessage(i)}}onOpen(){this._opened=!0,this._timer&&(clearTimeout(this._timer),this._timer=null),this._startPing(),super.emit.call(this,"open",this)}onClose(){this.log("onClose"),this._closing?this._closed||(this._closed=!0,this._reset(),super.emit.call(this,"close",this)):this.close()}onMessage(e){if(e.id&&e.type&&e.event){var t=Number(e.type);if(1===t)this._recv(e.event,e.opts,e.data);else if(2===t){if(!e.eventId)return void this.info(`Message(${t}) invalid.`);var s=new i(this,e.event,e.eventId);this._recv(e.event,e.opts,e.data,s.reply)}else if(3===t){var r=void 0;if(e.eventId&&(r=this._findEvent(e.eventId)),!r)return void this.info(`Reply event(id=${e.eventId}) invalid.`);this._removeEvent(e.eventId);var n=[this];"message"===e.event?(e.opts=e.opts?e.opts:{},n=[this,e.opts,e.data]):Array.isArray(e.data)&&(n=e.data).unshift(this),r.apply(r,n)}else this.info(`Reply event(type=${e.type}) invalid.`)}else this.info("Message invalid.")}}}();